<% if current_order.present? && cart_checkout_payment_method.present? %>
  <div id="stripe-payment-request" class="stripe-payment-request" style="display:none">
    <div id="payment-request-button"
      data-stripe-config="<%= cart_checkout_payment_method.stripe_config(current_order).to_json %>"
      data-order-token="<%= current_order.guest_token %>"
      data-submit-url="<%= api_checkout_path(current_order.number) %>"
      data-complete-url="<%= checkout_path %>"
      class="payment-request-button">
    </div>

    <div id="card-errors" class='errorExplanation' role="alert" style="display: none">
    </div>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <%= javascript_include_tag "solidus_stripe/stripe-init" %>

  <script>
    var paymentRequestConfig = Spree.stripePaymentMethod.config.payment_request;
    var errorElement = $('#card-errors');

    if (typeof paymentRequestConfig !== 'undefined') {
      paymentRequestConfig.requestShipping = true;

      var onPrButtonMounted = function(buttonId, success) {
        var container = document.getElementById('stripe-payment-request');

        if (success) {
          container.style.display = '';
        } else {
          container.style.display = 'none';
        }
      };

      var paymentRequest = setUpPaymentRequest(paymentRequestConfig, onPrButtonMounted);

      function handlePayment(result) {
        fetch('/stripe/update_order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            shipping_address: result.shippingAddress,
            shipping_option: result.shippingOption,
            email: result.payerEmail,
            name: result.payerName,
            authenticity_token: authToken
          })
        }).then(function(response) {
          response.json().then(function(json) {
            handleServerResponse(json, result);
          })
        });
      };

      function stripeTokenHandler(token) {
        return {
          order: {
            payments_attributes: [
              {
                payment_method_id: Spree.stripePaymentMethod.config.id,
                source_attributes: {
                  gateway_payment_profile_id: token.id,
                  last_digits: token.card.last4,
                  month: token.card.exp_month,
                  year: token.card.exp_year
                }
              }
            ]
          }
        }
      };

      function submitPayment(payment) {
        $.ajax({
          url : $('[data-submit-url]').data('submit-url'),
          headers: {
            'X-Spree-Order-Token': $('[data-order-token]').data('order-token')
          },
          type : 'PATCH',
          contentType: 'application/json',
          data : JSON.stringify(stripeTokenHandler(payment.paymentMethod)),
          success: function() {
            window.location = $('[data-complete-url]').data('complete-url');
          },
          error: function(xhr,status,error) {
            showError(xhr.responseJSON.error);
          }
        });
      };
    }
  </script>
<% end %>
